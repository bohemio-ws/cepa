import React, { useState, useEffect } from 'react';
import { ClipboardCheck, Home, Map, MessageSquare, Save, Loader2, Sparkles, Building2 } from 'lucide-react';

const App = () => {
  const [fecha, setFecha] = useState(new Date().toISOString().split('T')[0]);
  const [operario] = useState("Helena Buitrago Vara");
  const [observaciones, setObservaciones] = useState("");
  const [loading, setLoading] = useState(false);
  const [notif, setNotif] = useState({ show: false, msg: "", error: false });

  // Estado para las 10 aulas
  const [aulas, setAulas] = useState(
    Array.from({ length: 10 }, (_, i) => ({ id: i + 1, checked: false, nota: "" }))
  );

  // Estado para zonas comunes
  const [zonas, setZonas] = useState([
    { id: 'aseos', nombre: 'Baños / Aseos', checked: false, nota: "" },
    { id: 'pasillos', nombre: 'Pasillos y Escaleras', checked: false, nota: "" },
    { id: 'secretaria', nombre: 'Secretaría / Despachos', checked: false, nota: "" }
  ]);

  // URL de tu Script de Google (debes pegarla aquí para que funcione el envío real)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcZX1hntXXpqyTYBWhzZcbV83xbntJ2sAAc5v4ggkeuoZ9Ey-5nPzcx2OuuOt3MYvh/exe"; 

  const showNotification = (msg, error = false) => {
    setNotif({ show: true, msg, error });
    setTimeout(() => setNotif({ show: false, msg: "", error: false }), 5000);
  };

  const handleAulaChange = (id, field, value) => {
    setAulas(aulas.map(a => a.id === id ? { ...a, [field]: value } : a));
  };

  const handleZonaChange = (id, field, value) => {
    setZonas(zonas.map(z => z.id === id ? { ...z, [field]: value } : z));
  };

  const enviarRegistro = async () => {
    if (!SCRIPT_URL) {
      showNotification("Configura la URL del Script en el código primero.", true);
      return;
    }

    setLoading(true);

    const aulasLimpias = aulas
      .filter(a => a.checked)
      .map(a => `Aula ${a.id}${a.nota ? ` [${a.nota}]` : ""}`)
      .join(", ");

    const zonasLimpias = zonas
      .filter(z => z.checked)
      .map(z => `${z.nombre}${z.nota ? ` [${z.nota}]` : ""}`)
      .join(", ");

    const data = {
      timestamp: new Date().toLocaleString(),
      fecha,
      operario,
      aulas: aulasLimpias || "Ninguna",
      zonasComunes: zonasLimpias || "Ninguna",
      incidencias: observaciones || "Sin incidencias"
    };

    try {
      await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(data)
      });
      
      showNotification("✅ ¡Reporte guardado en la hoja de cálculo!");
      // Resetear formulario
      setObservaciones("");
      setAulas(aulas.map(a => ({ ...a, checked: false, nota: "" })));
      setZonas(zonas.map(z => ({ ...z, checked: false, nota: "" })));
    } catch (e) {
      showNotification("❌ Error al enviar los datos.", true);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-sky-100 to-blue-200 pb-12 font-sans">
      {/* Notificación */}
      {notif.show && (
        <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-2xl shadow-2xl transition-all animate-bounce font-bold text-white text-sm ${notif.error ? 'bg-red-500' : 'bg-blue-600'}`}>
          {notif.msg}
        </div>
      )}

      {/* Header */}
      <div className="bg-sky-900 text-white pt-12 pb-20 px-6 rounded-b-[40px] shadow-xl relative overflow-hidden">
        <div className="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
          <Building2 size={200} />
        </div>
        <div className="max-w-lg mx-auto text-center relative z-10">
          <div className="inline-flex items-center gap-2 bg-sky-800/40 backdrop-blur-md px-4 py-1 rounded-full text-[10px] font-bold tracking-widest mb-4 border border-white/10 uppercase">
            <Sparkles size={12} className="text-sky-300" /> Sistema de Control v3.5
          </div>
          <h1 className="text-4xl font-black tracking-tight mb-2">CEPA TARANCÓN</h1>
          <p className="text-sky-200 font-semibold flex items-center justify-center gap-2">
            Registro Diario: {operario}
          </p>
        </div>
      </div>

      <main className="max-w-lg mx-auto p-4 -mt-10 space-y-6 relative z-10">
        
        {/* Card Identificación */}
        <div className="bg-white/80 backdrop-blur-lg rounded-[24px] p-6 shadow-sm border border-white/50 grid grid-cols-2 gap-4">
          <div className="space-y-1">
            <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Fecha</label>
            <input 
              type="date" 
              value={fecha} 
              onChange={(e) => setFecha(e.target.value)}
              className="w-full bg-slate-100/50 border-none rounded-xl p-3 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>
          <div className="space-y-1">
            <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Personal</label>
            <div className="w-full bg-slate-100/50 rounded-xl p-3 text-sm font-bold text-slate-400">
              Helena B.
            </div>
          </div>
        </div>

        {/* Sección Aulas */}
        <div className="bg-white/80 backdrop-blur-lg rounded-[24px] shadow-sm border border-white/50 overflow-hidden">
          <div className="bg-white/50 px-6 py-4 border-b border-slate-100 flex items-center gap-3">
            <div className="p-2 bg-blue-600 text-white rounded-lg"><Home size={18} /></div>
            <h2 className="font-bold text-slate-800 text-sm uppercase tracking-wider">Aulas 1 al 10</h2>
          </div>
          <div className="p-2 space-y-1">
            {aulas.map((aula) => (
              <div key={aula.id} className="p-3 hover:bg-white/60 rounded-2xl transition-all border border-transparent hover:border-white">
                <div className="flex items-center justify-between">
                  <label className="flex items-center gap-4 cursor-pointer flex-1">
                    <input 
                      type="checkbox" 
                      checked={aula.checked}
                      onChange={(e) => handleAulaChange(aula.id, 'checked', e.target.checked)}
                      className="w-6 h-6 rounded-lg accent-blue-600 cursor-pointer"
                    />
                    <span className={`font-bold text-sm ${aula.checked ? 'text-blue-700' : 'text-slate-600'}`}>Aula {aula.id}</span>
                  </label>
                </div>
                {aula.checked && (
                  <input 
                    type="text" 
                    placeholder={`¿Alguna nota para el aula ${aula.id}?`}
                    value={aula.nota}
                    onChange={(e) => handleAulaChange(aula.id, 'nota', e.target.value)}
                    className="mt-2 w-full bg-transparent border-b border-dashed border-slate-300 text-xs py-1 outline-none focus:border-blue-500 transition-colors"
                  />
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Sección Zonas Comunes */}
        <div className="bg-white/80 backdrop-blur-lg rounded-[24px] shadow-sm border border-white/50 overflow-hidden">
          <div className="bg-white/50 px-6 py-4 border-b border-slate-100 flex items-center gap-3">
            <div className="p-2 bg-slate-700 text-white rounded-lg"><Map size={18} /></div>
            <h2 className="font-bold text-slate-800 text-sm uppercase tracking-wider">Zonas Comunes</h2>
          </div>
          <div className="p-2 space-y-1">
            {zonas.map((zona) => (
              <div key={zona.id} className="p-3 hover:bg-white/60 rounded-2xl transition-all border border-transparent hover:border-white">
                <div className="flex items-center justify-between">
                  <label className="flex items-center gap-4 cursor-pointer flex-1">
                    <input 
                      type="checkbox" 
                      checked={zona.checked}
                      onChange={(e) => handleZonaChange(zona.id, 'checked', e.target.checked)}
                      className="w-6 h-6 rounded-lg accent-blue-600 cursor-pointer"
                    />
                    <span className={`font-bold text-sm ${zona.checked ? 'text-blue-700' : 'text-slate-600'}`}>{zona.nombre}</span>
                  </label>
                </div>
                {zona.checked && (
                  <input 
                    type="text" 
                    placeholder="Detalles (limpieza profunda, falta jabón...)"
                    value={zona.nota}
                    onChange={(e) => handleZonaChange(zona.id, 'nota', e.target.value)}
                    className="mt-2 w-full bg-transparent border-b border-dashed border-slate-300 text-xs py-1 outline-none focus:border-blue-500"
                  />
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Incidencias */}
        <div className="bg-white/80 backdrop-blur-lg rounded-[24px] p-6 shadow-sm border border-white/50 space-y-3">
          <div className="flex items-center gap-2 text-slate-500 mb-2">
            <MessageSquare size={16} />
            <label className="text-[10px] font-bold uppercase tracking-widest">Observaciones e Incidencias</label>
          </div>
          <textarea 
            value={observaciones}
            onChange={(e) => setObservaciones(e.target.value)}
            rows="3"
            placeholder="Averías, falta de material, desperfectos..."
            className="w-full bg-slate-100/50 border-none rounded-xl p-4 text-sm font-medium text-slate-700 outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
        </div>

        {/* Botón Guardar */}
        <button 
          onClick={enviarRegistro}
          disabled={loading}
          className={`w-full py-6 rounded-[24px] font-bold text-lg flex items-center justify-center gap-3 transition-all active:scale-95 shadow-lg ${loading ? 'bg-slate-400' : 'bg-gradient-to-r from-blue-600 to-sky-700 text-white hover:brightness-110'}`}
        >
          {loading ? <Loader2 className="animate-spin" /> : <Save size={24} />}
          {loading ? "ENVIANDO..." : "GUARDAR REGISTRO"}
        </button>

        <footer className="text-center py-6">
          <div className="text-[9px] text-slate-500 font-bold tracking-[0.4em] uppercase opacity-60">
            CEPA Tarancón · Control de Calidad
          </div>
        </footer>
      </main>
    </div>
  );
};

export default App;